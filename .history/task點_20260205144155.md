# AI 行動邏輯分析（目前版本）

## 主要程式位置
- `src/hooks/useGameAI.ts`
- `src/hooks/usePlayerActions.ts`（`attemptMove`、`handleActionComplete`）
- `src/gameInit.ts`（PvE 開局自動配置）

## 目前 AI 決策流程
1. **觸發條件**：僅在 `gameMode === 'pve'`、`currentPlayer === P2`、且 `gameOver === false` 時啟動（`useGameAI.ts:21-24`）。
2. **回合節奏**：每次觸發後延遲 1 秒執行一次 AI（`useGameAI.ts:75`）。
3. **單位選擇**：從 P2 所有「存活且尚未行動」單位中隨機選一隻（`useGameAI.ts:28, 36`）。
4. **行為選擇**：
   - 60% 嘗試移動（`useGameAI.ts:39`）
   - 40% 直接結束該單位行動（`useGameAI.ts:72`）
5. **移動策略**：
   - 只考慮上下左右四方向（`useGameAI.ts:42-44`）
   - 以「到 P1 旗幟的曼哈頓距離」選最短方向（`useGameAI.ts:41, 46-57`）
   - 計算移動能量後呼叫 `attemptMove`（`useGameAI.ts:65-67`）
6. **回合推進**：行動完成透過 `handleActionComplete` 切換到下一位可行動單位或下一玩家（`usePlayerActions.ts:345-498`）。

## PvE 開局 AI 預配置
- 進入 `pve/sandbox` 時，P2 會：
  - 將非將軍單位（index 1~4）隨機交換位置 10 次（`gameInit.ts:170-179`）
  - 在右半區隨機放置 3 顆普通地雷（`gameInit.ts:180-200`）

## 我發現的關鍵問題（高優先）
1. **AI 計時器會被頻繁重設，可能導致 AI 幾乎不出手**  
   `useEffect` 依賴中包含整個 `gameState`（`useGameAI.ts:95`）。而 `timeLeft` 每 100ms 更新一次（`useGameLoop.ts:84-88`），會反覆清掉 1 秒 timeout（`useGameAI.ts:77`）再重設，造成 AI timeout 很難真正觸發。

2. **移動失敗時不會補救，AI 可能原地卡住直到倒數結束**  
   `attemptMove` 若遇到障礙、佔位、能量不足、能量上限等會直接 `return`（`usePlayerActions.ts:560-578`）。
   目前 AI 在 `attemptMove(...)` 後直接 `return`（`useGameAI.ts:67-68`），若這步失敗，沒有改走其他格或改為 `handleActionComplete`，可能造成該 AI 單位遲遲不結束動作。

3. **路徑評估未先過濾不可走格**  
   AI 在選最佳方向時只看邊界與距離（`useGameAI.ts:49-57`），未先排除障礙、單位佔位、地雷風險、特殊區域等，導致常選到「理論變近但實際無法移動或很虧」的位置。

## 中優先觀察
- AI 目前只有「走一步 / 跳過」兩種行為，未使用攻擊、拆雷、放雷、技能、旗幟策略。
- 40% 跳過會觸發被動補血（若未移動且未耗能，+3 HP，`usePlayerActions.ts:407-414`），可能讓 AI 行為看起來更保守且隨機。
- 決策無記憶（無 threat map、無目標優先級、無長路徑），同局內表現波動大。

## 總結
目前 AI 屬於「隨機單位 + 單步趨旗」的極簡版本；最大風險不是弱，而是**可能因 effect 依賴與失敗分支處理不足而卡行為**。建議先修正「timeout 重設」與「移動失敗 fallback」，再進階到戰術層（攻擊/技能/目標評分）。

## 本輪已處理（2026-02-05）
- 已修正 `useGameAI` 依賴設計，移除「整個 gameState 造成 timeout 一直重設」問題，改為只在關鍵狀態變化時觸發。
- 已加入 AI 移動候選格檢查：邊界、障礙、佔位、能量、能量上限（cap）。
- 已加入移動失敗 fallback：若第一候選失敗會依序嘗試其他候選，最終仍失敗則自動 `handleActionComplete`，避免卡住。
- 已加入簡易風險評分（敵方地雷、核雷鄰域、麒麟領域入場）作為路徑排序依據。
- 已鎖定 PvE 的 P2（AI 回合）玩家輸入，避免人類誤操作 AI 單位；AI 反應延遲由 1 秒降到 450ms。

## AI 升級進度（Step 1 / Step 2 啟動）
- 已建立 `src/ai/` 模組骨架：`types.ts`、`config.ts`、`evaluator.ts`、`generator.ts`、`selector.ts`、`executor.ts`。
- `useGameAI` 已改為調度層：讀 state → 產生候選 → 選擇 → 執行 → 失敗 fallback。
- 已接入 `AIDifficulty`（目前預設 `normal`）與 action 映射（move/attack/scan/place/disarm/旗幟/結束）。
- 第一層「選單位評分」已啟用（攻擊機會、旗幟壓力、生存、能量效率 + 難度權重）。